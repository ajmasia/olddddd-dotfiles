#!/usr/bin/env bash

# AMD Ryzen 7 4800H processor profiler CLI tool for Slimbook computers
# If you use different AND processor, please review the params here https://shorturl.at/jHJ35

COLOR_OFF='\033[0m' # Text Reset
GREEN='\033[0;32m'  # Green
YELLOW='\033[0;33m' # Yellow

CPU=$(cat /proc/cpuinfo | grep name | uniq | cut -d ':' -f2 | sed -r "s/^\s+//g")

help() {
	printf "${YELLOW}Slimbook ${CPU} profile updater tool${COLOR_OFF}\n\n"
	printf "${GREEN}Usage amd-controller [command <option>] [option]${COLOR_OFF}\n\n"

	printf "${YELLOW}Commands:${COLOR_OFF}\n"
	echo "set <option>       Set processor profile"
	echo

	printf "${YELLOW}Options:${COLOR_OFF}\n"
	echo "-b, --base         Set your processor to work with a base profile"
	echo "-s, --slow         Set your processor to work with a slow profile"
	echo "-m, --medium       Set your processor to work with a medium profile"
	echo "-h, --high         Set your processor to work with a high profil"
	echo

	printf "${YELLOW}Flags:${COLOR_OFF}\n"
	echo "-h, --help         Show CLI help"
	echo "-i, --ifo          Show processor profile info"
	echo

	printf "${GREEN}Example: Type 'amd-controller set -s' to set your processor to work with a slow profile${COLOR_OFF}\n"
	echo
	echo "Inspired by: https://shorturl.at/hqrAL"
	echo "Review params for other AMD processors here: https://shorturl.at/jHJ35"
}

check_dependences() {
	if ! command -v ryzenadj &>/dev/null 2>&1; then
		printf >&2 "${RED}Error: ryzenadj could not be found\n"
		exit 1
  elif ! command -v notify-send &>/dev/null 2>&1; then
		printf >&2 "${RED}Error: notify-send could not be found\n"
		exit 1
  fi
}

set_base_profile() {
	sudo ryzenadj --tctl-temp=95 --slow-limit=30000 --stapm-limit=30000 --fast-limit=35000 &>/dev/null
	printf "${GREEN}ðŸ›   BASE profile set successfully for $CPU processor\n"
	notify-send "AMD Controller" "ðŸ”” BASE profile set successfully for ${CPU}" -t 4000
}

set_slow_profile() {
	sudo ryzenadj --tctl-temp=95 --slow-limit=10000 --stapm-limit=10000 --fast-limit=10000 &>/dev/null
	printf "${GREEN}ðŸ›   SLOW profile set successfully for $CPU processor\n"
	notify-send "AMD Controller" "ðŸ”” SLOW profile set successfully for ${CPU}" -t 4000
}

set_medium_profile() {
	sudo ryzenadj --tctl-temp=95 --slow-limit=15000 --stapm-limit=15000 --fast-limit=25000 &>/dev/null
	printf "${GREEN}ðŸ›   MEDIUM profile set successfully for $CPU processor\n"
	notify-send "AMD Controller" "ðŸ”” MEDIUM profile set successfully for ${CPU}" -t 4000
}

set_high_profile() {
	sudo ryzenadj --tctl-temp=95 --slow-limit=70000 --stapm-limit=80000 --fast-limit=100000 &>/dev/null
	printf "${GREEN}ðŸ›   HIGH profile set successfully for $CPU processor\n"
	notify-send "AMD Controller" "ðŸ””HIGH profile set successfully for ${CPU}" -t 4000
}

get_cpu_profile_values() {
  STAPM_LIMIT=$(sudo ryzenadj -i | grep "STAPM LIMIT" | awk '{print $5}')
  PPT_LIMIT_FAST=$(sudo ryzenadj -i | grep "PPT LIMIT FAST" | awk '{print $6}')
  PPT_LIMIT_SLOW=$(sudo ryzenadj -i | grep "PPT LIMIT SLOW" | awk '{print $6}')
}

show_processor_profile_info() {
	# sudo ryzenadj -i
  get_cpu_profile_values


  printf "ï‹› ${GREEN}${CPU} currrent profile info${COLOR_OFF}\n\n"

  printf "Param          | Description                | Value  \n"
  echo "---------------|----------------------------|--------"
  printf "STAPM LIMIT    | Sustained Power Limit (mW) | ${STAPM_LIMIT}\n"
  printf "PPT LIMIT SLOW | Average Power Limit (mW)   | ${PPT_LIMIT_SLOW}\n"
  printf "PPT LIMIT FAST | Actual Power Limit (mW)    | ${PPT_LIMIT_FAST}\n\n"

  printf "${YELLOW}STAPM (Skin Temperature Aware Power Management)${COLOR_OFF}\n"
  printf "Your device's STAPM configuration is set by the manufacturer and differs depending on the processor used and the form factor of the device\n\n"

  printf "${YELLOW}PPT (Package Power Tracking)${COLOR_OFF}\n"
  printf "PPT is a measurement of power to the CPU Socket on the motherboard and not the CPU itself\n\n"

  printf "${YELLOW}More info${COLOR_OFF}\n"
  printf "Ryzenadj: https://github.com/FlyGoat/RyzenAdj\n"
  printf "AMDController: https://ryzencontroller.com/\n\n"

	printf "${GREEN}For more help, please type 'amd-controller -h, --help'${COLOR_OFF}\n\n"
  
}

check_dependences

case "$1" in
set)
	case $2 in
	-b | --base)
		set_base_profile
		;;
	-s | --slow)
		set_slow_profile
		;;
	-m | --medium)
		set_medium_profile
		;;
	-h | --high)
		set_high_profile
		;;
	-h | --help)
		help
		;;
	*)
		printf "${YELLOW}Invalid option\n${COLOR_OFF}"
		help
		;;
	esac
	;;
-i | --info)
	show_processor_profile_info
	;;
-h | --help)
	help
	;;
*)
	printf "${YELLOW}Invalid command or option\n${COLOR_OFF}"
	help
	;;
esac
